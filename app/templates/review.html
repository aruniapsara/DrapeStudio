{% extends "base.html" %}

{% block title %}Review â€” DrapeStudio{% endblock %}

{% block content %}
<section class="page-section">
    <h2>Step 3: Review &amp; Generate</h2>

    <div class="review-summary">
        <h3>Your Configuration</h3>
        <div class="review-grid">

            <div class="review-section">
                <h4>Garment Images</h4>
                <div id="review-images" class="review-images"></div>
            </div>

            <div class="review-section">
                <h4>Product &amp; Model</h4>
                <dl class="review-details" id="review-model"></dl>
                <div id="review-model-photo" style="display:none; margin-top:0.75rem;">
                    <p style="font-size:0.8rem;color:var(--color-text-muted);margin-bottom:0.3rem;font-weight:600;">MODEL REFERENCE PHOTO</p>
                    <img id="review-model-photo-img" src="" alt="Model photo"
                         style="width:80px;height:80px;object-fit:cover;border-radius:6px;border:1px solid var(--color-border);">
                </div>
            </div>

            <div class="review-section">
                <h4>Scene Settings</h4>
                <dl class="review-details" id="review-scene"></dl>
            </div>

            <div class="review-section" id="review-measurements-section" style="display:none;">
                <h4>Measurements</h4>
                <dl class="review-details" id="review-measurements"></dl>
            </div>

        </div>

        <div class="cost-indicator">
            <p><strong>Cost:</strong> 1 credit per generation (3 output images)</p>
        </div>
    </div>

    <div class="form-actions">
        <a href="/configure" class="btn btn-secondary">Back: Edit Settings</a>
        <button id="btn-generate" class="btn btn-primary btn-large" onclick="submitGeneration()">
            Generate Images
        </button>
    </div>
</section>

<script>
    const LABELS = {
        product_type:           'Product Type',
        age_range:              'Age Range',
        gender_presentation:    'Gender',
        ethnicity:              'Ethnicity',
        skin_tone:              'Skin Tone',
        body_type:              'Body Type',
        hair_style:             'Hair Style',
        hair_color:             'Hair Color',
        additional_description: 'Additional Details',
        environment:            'Environment',
        pose_preset:            'Pose',
        framing:                'Framing',
    };

    const VALUE_LABELS = {
        clothing:        'Clothing',
        accessories:     'Accessories',
        sri_lankan:      'Sri Lankan',
        indian:          'Indian',
        middle_eastern:  'Middle Eastern',
        african:         'African',
        european:        'European',
        feminine:        'Female',
        masculine:       'Male',
        neutral:         'Unisex',
        long_straight:   'Long Straight',
        long_wavy:       'Long Wavy',
        long_curly:      'Long Curly',
        short_bob:       'Short Bob',
        medium_layered:  'Medium Layered',
        braided:         'Braided / Updo',
        short_tapered:   'Short Tapered',
        medium_textured: 'Medium Textured',
        buzz_cut:        'Buzz Cut',
        slicked_back:    'Slicked Back',
        afro_curly:      'Afro / Curly',
        dreadlocks:      'Dreadlocks',
        short_straight:  'Short Straight',
        medium_length:   'Medium Length',
        shaved:          'Shaved',
        natural_curly:   'Natural Curly',
        black:           'Black',
        dark_brown:      'Dark Brown',
        medium_brown:    'Medium Brown',
        light_brown:     'Light Brown / Caramel',
        blonde:          'Blonde',
        auburn:          'Red / Auburn',
        grey:            'Grey / Silver',
        studio_white:    'Studio - White',
        studio_beige:    'Studio - Beige',
        outdoor_street:  'Outdoor - Street',
        outdoor_park:    'Outdoor - Park',
        outdoor_beach:   'Outdoor - Beach',
        indoor_cafe:     'Indoor - Cafe',
        indoor_home:     'Indoor - Home',
        front_standing:  'Front Standing',
        walking:         'Walking',
        three_quarter:   'Three-Quarter Turn',
        seated:          'Seated',
        full_body:       'Full Body',
        waist_up:        'Waist Up',
    };

    function fmt(val) {
        return VALUE_LABELS[val] || val.replace(/_/g, ' ');
    }

    const params = new URLSearchParams(window.location.search);

    // Product + Model section
    const modelFields = [
        'product_type', 'age_range', 'gender_presentation', 'ethnicity',
        'skin_tone', 'body_type', 'hair_style', 'hair_color', 'additional_description'
    ];
    const modelDl = document.getElementById('review-model');
    modelFields.forEach(function(f) {
        const val = params.get(f);
        if (val) {
            modelDl.innerHTML += '<dt>' + (LABELS[f] || f.replace(/_/g, ' ')) + '</dt><dd>' + fmt(val) + '</dd>';
        }
    });

    // Model photo preview
    const modelPhotoUrl = params.get('model_photo_url') || '';
    if (modelPhotoUrl) {
        document.getElementById('review-model-photo').style.display = 'block';
        document.getElementById('review-model-photo-img').src = '/v1/files/' + modelPhotoUrl.replace('local://', '');
    }

    // Scene section
    const sceneFields = ['environment', 'pose_preset', 'framing'];
    const sceneDl = document.getElementById('review-scene');
    sceneFields.forEach(function(f) {
        const val = params.get(f);
        if (val) {
            sceneDl.innerHTML += '<dt>' + (LABELS[f] || f.replace(/_/g, ' ')) + '</dt><dd>' + fmt(val) + '</dd>';
        }
    });

    // Measurements section
    const measureMap = {
        m_height_cm:     'Height',
        m_weight_kg:     'Weight',
        m_chest_bust_cm: 'Chest / Bust',
        m_waist_cm:      'Waist',
        m_hips_cm:       'Hips',
        m_inseam_cm:     'Inseam',
        m_shoe_size_eu:  'Shoe Size (EU)',
    };
    const measureUnits = {
        m_height_cm:     ' cm',
        m_weight_kg:     ' kg',
        m_chest_bust_cm: ' cm',
        m_waist_cm:      ' cm',
        m_hips_cm:       ' cm',
        m_inseam_cm:     ' cm',
        m_shoe_size_eu:  '',
    };
    const measureDl = document.getElementById('review-measurements');
    var hasMeasurements = false;
    Object.keys(measureMap).forEach(function(key) {
        const val = params.get(key);
        if (val) {
            hasMeasurements = true;
            measureDl.innerHTML += '<dt>' + measureMap[key] + '</dt><dd>' + val + measureUnits[key] + '</dd>';
        }
    });
    if (hasMeasurements) {
        document.getElementById('review-measurements-section').style.display = '';
    }

    // Garment image previews from sessionStorage
    const uploadedFiles = JSON.parse(sessionStorage.getItem('uploadedFiles') || '[]');
    const imgContainer = document.getElementById('review-images');
    if (uploadedFiles.length > 0) {
        imgContainer.innerHTML = uploadedFiles.map(function(url, i) {
            return '<img src="/v1/files/' + url.replace('local://', '') + '" alt="Garment ' + (i + 1) + '">';
        }).join('');
    } else {
        imgContainer.innerHTML = '<p>No images found.</p>';
    }

    function buildMeasurements() {
        const schemaMap = {
            m_height_cm:     'height_cm',
            m_weight_kg:     'weight_kg',
            m_chest_bust_cm: 'chest_bust_cm',
            m_waist_cm:      'waist_cm',
            m_hips_cm:       'hips_cm',
            m_inseam_cm:     'inseam_cm',
            m_shoe_size_eu:  'shoe_size_eu',
        };
        const meas = {};
        Object.keys(schemaMap).forEach(function(urlKey) {
            const val = params.get(urlKey);
            if (val) meas[schemaMap[urlKey]] = parseFloat(val);
        });
        return Object.keys(meas).length > 0 ? meas : null;
    }

    async function submitGeneration() {
        const btn = document.getElementById('btn-generate');
        btn.disabled = true;
        btn.textContent = 'Submitting...';

        const body = {
            idempotency_key: crypto.randomUUID(),
            product_type: params.get('product_type') || 'clothing',
            garment_images: uploadedFiles,
            model_params: {
                age_range:              params.get('age_range'),
                gender_presentation:    params.get('gender_presentation'),
                ethnicity:              params.get('ethnicity') || '',
                skin_tone:              params.get('skin_tone'),
                body_mode:              'simple',
                body_type:              params.get('body_type'),
                hair_style:             params.get('hair_style') || '',
                hair_color:             params.get('hair_color') || '',
                additional_description: params.get('additional_description') || '',
                model_photo_url:        params.get('model_photo_url') || null,
                measurements:           buildMeasurements(),
            },
            scene: {
                environment:  params.get('environment'),
                pose_preset:  params.get('pose_preset'),
                framing:      params.get('framing'),
            },
            output: { count: 3, resolution: 'high' },
        };

        try {
            const resp = await fetch('/v1/generations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
            const data = await resp.json();
            if (resp.ok) {
                window.location.href = '/generating/' + data.id;
            } else {
                alert('Error: ' + (data.detail || 'Failed to create generation'));
                btn.disabled = false;
                btn.textContent = 'Generate Images';
            }
        } catch (err) {
            alert('Network error: ' + err.message);
            btn.disabled = false;
            btn.textContent = 'Generate Images';
        }
    }
</script>
{% endblock %}
